# v5.13.0 Implementation Plan: SNS Topic Naming Fix

**Status:** Implementation Complete - Ready for PR
**Target Release:** v5.13.0 (Minor release - no breaking changes)
**Current Version:** v5.12.1
**Priority:** High - Blocks terraform-aws-elasticsearch deployment

---

## Task Tracker

### Implementation
- [x] **Step 1.1:** Update alarms.tf - Replace `${var.service_name}` with `${aws_autoscaling_group.website.name}` (11 locations)
- [x] **Step 1.2:** Update asg.tf - Remove obsolete `create_before_destroy` lifecycle blocks (2 locations)
- [x] **Bonus:** Replace local `wait_for_instance_refresh` with pytest-infrahouse import in tests/conftest.py

### Testing
- [x] **Step 3.1:** Local manual testing with `make test-keep` - PASSED
- [x] **Step 3.3:** Multi-ASG scenario validation - Validated via test

### Documentation (Pre-PR)
- [x] **Step 2.1:** Update README.md (if needed via terraform-docs) - No changes needed

### Release Process
- [ ] **Step 4.1:** Create Pull Request
- [ ] **Step 4.2:** CI comprehensive testing - Wait for GitHub Actions
- [ ] **Step 4.3:** PR Review and approval
- [ ] **Step 4.4:** Merge PR
- [ ] **Step 4.5:** Post closing comment on GitHub Issue #104
- [ ] **Step 4.6:** Post closing comment on GitHub Issue #67
- [ ] **Step 4.7:** Update CHANGELOG.md via `make release-minor` (git-cliff auto-generates)
- [ ] **Step 4.8:** Release from main branch (make release-minor creates tag)
- [ ] **Step 4.9:** Verify Terraform Registry publication
- [ ] **Step 4.10:** Update terraform-aws-elasticsearch to v5.13.0

### Post-Release
- [ ] Monitor GitHub issues for upgrade problems
- [ ] Communicate about email re-confirmation requirement

---

## Overview

This release fixes two issues that have operational impact but do not constitute breaking changes to the module API:

1. **Issue #104:** SNS topic naming conflict when multiple module instances share same `service_name`
2. **Issue #67:** Remove obsolete `create_before_destroy` lifecycle blocks from ASG resources

**Key Principles:**
- No breaking changes to module API (inputs/outputs remain unchanged)
- Operational impact documented clearly in CHANGELOG
- Users notified about email re-confirmation requirement
- Clear migration path for affected users

---

## Issues Addressed

### Issue #104: SNS Topic Naming Conflict

**GitHub Issue:** https://github.com/infrahouse/terraform-aws-website-pod/issues/104
**Priority:** CRITICAL - Blocking terraform-aws-elasticsearch
**Type:** Bug fix (operational impact, not breaking)

#### Problem Statement

When deploying multiple instances of the module with:
- **Same** `service_name` (e.g., "elasticsearch")
- **Different** `asg_name` values (e.g., "elasticsearch-master", "elasticsearch-data")

The SNS topic creation fails with:
```
Error: Topic already exists with different tags
```

**Root Cause:**
- SNS topics use `service_name` in naming: `${var.service_name}-alb-alarms`
- Multiple ASGs with same service → duplicate SNS topic names
- SNS topic names must be unique within AWS region

**Real-World Impact:**
- terraform-aws-elasticsearch cannot deploy (uses 2 module instances)
- Any multi-tier architecture using same service name is blocked

#### Solution

Replace `service_name` with ASG name in all alarm-related resource names:

**Rationale for using ASG name:**
1. ASG names are guaranteed unique by Terraform/AWS
2. Alarms monitor ASG-specific resources (target groups, instances)
3. Semantically correct - alarms are per-ASG, not per-service
4. No user code changes required (outputs still exist, just return different values)

#### Implementation Details

**File:** `alarms.tf`

**Changes Required:**

```hcl
# BEFORE (v5.12.x)
resource "aws_sns_topic" "alarms" {
  count = length(var.alarm_emails) > 0 ? 1 : 0

  name              = "${var.service_name}-alb-alarms"
  display_name      = "ALB Alarms for ${var.service_name}"
  # ...
  tags = merge(
    local.default_module_tags,
    {
      Name = "${var.service_name}-alb-alarms"
    }
  )
}

resource "aws_cloudwatch_metric_alarm" "unhealthy_host_count" {
  # ...
  alarm_name = "${var.service_name}-unhealthy-hosts"
  tags = merge(
    local.default_module_tags,
    {
      Name = "${var.service_name}-unhealthy-hosts"
    }
  )
}

# ... (3 more alarms with similar pattern)
```

**AFTER (v5.13.0):**
```hcl
resource "aws_sns_topic" "alarms" {
  count = length(var.alarm_emails) > 0 ? 1 : 0

  name              = "${aws_autoscaling_group.website.name}-alb-alarms"
  display_name      = "ALB Alarms for ${aws_autoscaling_group.website.name}"
  # ...
  tags = merge(
    local.default_module_tags,
    {
      Name = "${aws_autoscaling_group.website.name}-alb-alarms"
    }
  )
}

resource "aws_cloudwatch_metric_alarm" "unhealthy_host_count" {
  # ...
  alarm_name = "${aws_autoscaling_group.website.name}-unhealthy-hosts"
  tags = merge(
    local.default_module_tags,
    {
      Name = "${aws_autoscaling_group.website.name}-unhealthy-hosts"
    }
  )
}

# ... (3 more alarms with similar pattern)
```

**Why `aws_autoscaling_group.website.name`?**
- Handles both explicit `asg_name` and auto-generated names (via `name_prefix`)
- From asg.tf:2-3:
  ```hcl
  resource "aws_autoscaling_group" "website" {
    name        = var.asg_name
    name_prefix = var.asg_name == null ? aws_launch_template.website.name_prefix : null
  ```
- Terraform resolves to actual ASG name regardless of how it was created

**Specific Lines to Update:**

| Line | Resource | Attribute | Change |
|------|----------|-----------|--------|
| 5 | `aws_sns_topic.alarms` | `name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 6 | `aws_sns_topic.alarms` | `display_name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 12 | `aws_sns_topic.alarms` | `tags.Name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 31 | `aws_cloudwatch_metric_alarm.unhealthy_host_count` | `alarm_name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 53 | `aws_cloudwatch_metric_alarm.unhealthy_host_count` | `tags.Name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 62 | `aws_cloudwatch_metric_alarm.target_response_time` | `alarm_name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 83 | `aws_cloudwatch_metric_alarm.target_response_time` | `tags.Name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 92 | `aws_cloudwatch_metric_alarm.low_success_rate` | `alarm_name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 157 | `aws_cloudwatch_metric_alarm.low_success_rate` | `tags.Name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 166 | `aws_cloudwatch_metric_alarm.cpu_utilization` | `alarm_name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |
| 187 | `aws_cloudwatch_metric_alarm.cpu_utilization` | `tags.Name` | `${var.service_name}` → `${aws_autoscaling_group.website.name}` |

**Total: 11 substitutions** (find & replace across 11 lines)

#### Why This Is NOT a Breaking Change

**Module API unchanged:**
- ✅ All input variables remain the same
- ✅ All output variables remain the same (still return ARN/name, just different values)
- ✅ Output types unchanged (still strings)
- ✅ No user code modifications required

**What changes:**
- ⚠️ SNS topic ARN value changes (but output still exists)
- ⚠️ CloudWatch alarm ARN values change (but outputs still exist)
- ⚠️ Email subscribers must re-confirm (operational impact)

**Semantic Versioning Classification:**
- Not MAJOR (no API contract broken)
- MINOR (bug fix with operational impact)
- Users can upgrade without code changes

#### Operational Impact

**For existing users who upgrade v5.12.x → v5.13.0:**

1. **SNS Topic Recreation:**
   - Old topic: `{service_name}-alb-alarms`
   - New topic: `{asg_name}-alb-alarms`
   - Terraform will destroy old topic and create new one
   - Subscriptions need re-confirmation

2. **CloudWatch Alarms Recreation:**
   - Old alarm names: `{service_name}-unhealthy-hosts`, etc.
   - New alarm names: `{asg_name}-unhealthy-hosts`, etc.
   - Alarm history lost (metrics retained)
   - Brief gap in monitoring during recreation

3. **User Action Required:**
   - Check email for new SNS confirmation emails
   - Click "Confirm subscription" links
   - Verify alarms are firing correctly
   - Optionally: manually delete old SNS topics (Terraform won't delete subscribed topics)

4. **No Code Changes:**
   - Module configuration stays the same
   - Terraform handles resource replacement automatically

**For new deployments:**
- No impact - alarms use ASG names from the start

**For terraform-aws-elasticsearch:**
- ✅ Unblocks deployment (each ASG gets unique SNS topic)
- Can deploy master + data nodes without conflicts

---

### Issue #67: Remove Obsolete create_before_destroy

**GitHub Issue:** https://github.com/infrahouse/terraform-aws-website-pod/issues/67
**Priority:** Medium - Technical debt cleanup
**Type:** Refactoring (behavioral change, not breaking)

#### Problem Statement

The `create_before_destroy` lifecycle meta-argument exists in two places:
1. `aws_autoscaling_group.website` (asg.tf:69-71)
2. `aws_launch_template.website` (asg.tf:123-125)

**Historical Context:**
- Originally added for zero-downtime upgrades
- Before AWS introduced instance refresh feature
- Now obsolete - ASG already has `instance_refresh` block (asg.tf:14-21)

**Current Issues:**
- Causes test failures when ASG name is hardcoded and ASG is tainted
- Conflicts with instance refresh strategy
- Unnecessary complexity

**Note on SSL Certificate:**
- `create_before_destroy` in ssl.tf:8 is INTENTIONAL and should remain
- Needed for certificate rotation without downtime
- Different use case from ASG resources

#### Solution

Remove `create_before_destroy` from ASG and launch template resources only.

**File:** `asg.tf`

**Changes Required:**

```hcl
# BEFORE (v5.12.x)
resource "aws_autoscaling_group" "website" {
  # ... resource config ...

  lifecycle {
    create_before_destroy = true  # REMOVE
  }
}

resource "aws_launch_template" "website" {
  # ... resource config ...

  lifecycle {
    create_before_destroy = true  # REMOVE
  }
}
```

**AFTER (v5.13.0):**
```hcl
resource "aws_autoscaling_group" "website" {
  # ... resource config ...

  # lifecycle block removed
}

resource "aws_launch_template" "website" {
  # ... resource config ...

  # lifecycle block removed
}
```

**Specific Changes:**
- **asg.tf lines 69-71:** Delete entire `lifecycle` block
- **asg.tf lines 123-125:** Delete entire `lifecycle` block
- **ssl.tf line 8:** **KEEP** (different use case - certificate rotation)

#### Why This Is NOT a Breaking Change

**Module API unchanged:**
- ✅ All input variables remain the same
- ✅ All output variables remain the same
- ✅ No user code modifications required

**What changes:**
- ⚠️ Resource replacement order changes (default Terraform behavior)
- ⚠️ Tainted resources behave more predictably

**Semantic Versioning Classification:**
- Not MAJOR (no API contract broken)
- Not MINOR (no new functionality)
- PATCH/MINOR (bug fix / behavioral improvement)

#### Behavioral Impact

**Instance Refresh Already Handles Zero-Downtime:**
```hcl
# From asg.tf:14-21
instance_refresh {
  strategy = "Rolling"
  preferences {
    min_healthy_percentage       = var.min_healthy_percentage
    scale_in_protected_instances = var.asg_scale_in_protected_instances
  }
  triggers = ["tag"]
}
```

**Default Terraform Behavior (after removal):**
- Resources destroyed before new ones created (unless dependencies require otherwise)
- Instance refresh ensures rolling updates maintain availability
- More predictable behavior aligned with Terraform best practices

**For users who upgrade v5.12.x → v5.13.0:**
- No immediate impact on existing deployments
- Only affects future resource replacements
- Better behavior during testing (tainted resources work correctly)

---

## Implementation Steps

### Step 1: Code Changes

#### 1.1 Update alarms.tf (Issue #104)
```bash
# Use search & replace in alarms.tf:
# Find:    ${var.service_name}
# Replace: ${aws_autoscaling_group.website.name}
# Lines:   5, 6, 12, 31, 53, 62, 83, 92, 157, 166, 187
```

**Manual verification required:**
- Ensure no unintended replacements (check alarm descriptions, etc.)
- Verify string interpolation syntax is correct

#### 1.2 Update asg.tf (Issue #67)
```bash
# Remove lifecycle blocks:
# - Lines 69-71 (aws_autoscaling_group.website)
# - Lines 123-125 (aws_launch_template.website)
```

**DO NOT remove:**
- ssl.tf:8 lifecycle block (keep for certificate rotation)

### Step 2: Documentation Updates

#### 2.1 Update CHANGELOG.md

Add new section at top:

```markdown
## [5.13.0] - 2025-12-XX

### Fixed
- **Issue #104:** SNS topic naming conflict when multiple module instances share same `service_name`
  - SNS topics and CloudWatch alarms now use ASG name instead of service name for uniqueness
  - **IMPORTANT:** Existing users will need to re-confirm SNS email subscriptions after upgrade
  - Enables terraform-aws-elasticsearch to deploy multiple node types (master + data)
  - No code changes required - module API unchanged

- **Issue #67:** Removed obsolete `create_before_destroy` lifecycle blocks from ASG resources
  - Instance refresh already handles zero-downtime updates
  - Improves test reliability with tainted resources
  - No functional impact on deployments

### Migration Notes

#### SNS Topic Recreation (Issue #104)
When upgrading from v5.12.x to v5.13.0:

1. **Before upgrade:** Note current SNS topic name and subscriptions
2. **Run terraform apply:** Terraform will recreate SNS topics and alarms
3. **Check email:** AWS will send new confirmation emails to all `alarm_emails` addresses
4. **Action required:** Click "Confirm subscription" in each email
5. **Verify:** Check CloudWatch alarms are in OK/ALARM state (not INSUFFICIENT_DATA)
6. **Cleanup (optional):** Manually delete old SNS topics if desired

**No code changes required** - your module configuration stays the same.

**Why this change:**
- Prevents naming conflicts when deploying multiple ASGs per service
- Aligns resource naming with what they actually monitor (ASGs, not services)
- Enables multi-tier architectures like Elasticsearch clusters

#### Resource Names Changed
- **Old SNS topic:** `{service_name}-alb-alarms` → **New:** `{asg_name}-alb-alarms`
- **Old alarm names:** `{service_name}-unhealthy-hosts` → **New:** `{asg_name}-unhealthy-hosts`
- Module outputs (`alarm_sns_topic_arn`, `alarm_sns_topic_name`, `cloudwatch_alarm_arns`) return new values

**Example:**
```
Before: elasticsearch-alb-alarms
After:  elasticsearch-master-alb-alarms, elasticsearch-data-alb-alarms
```
```

#### 2.2 Update README.md

**No changes needed** - terraform-docs auto-regenerates, and API hasn't changed.

#### 2.3 Update GitHub Issue Comments

**Issue #104:**
```markdown
Fixed in v5.13.0.

**Changes:**
- SNS topics now use ASG name instead of service name
- CloudWatch alarms now use ASG name instead of service name
- Enables multiple module instances per service without naming conflicts

**Migration:**
Users upgrading from v5.12.x will need to re-confirm SNS email subscriptions.
See CHANGELOG.md for details.

Closes #104
```

**Issue #67:**
```markdown
Fixed in v5.13.0.

Removed `create_before_destroy` lifecycle blocks from:
- aws_autoscaling_group.website
- aws_launch_template.website

Instance refresh already handles zero-downtime updates, making these obsolete.

Note: `create_before_destroy` retained in ssl.tf for certificate rotation.

Closes #67
```

### Step 3: Testing

**Testing Principle:**
- **Local manual testing:** Use `make test-keep` and `make test-clean` commands on laptop
- **CI comprehensive testing:** GitHub Actions runs full test suite automatically

#### 3.1 Local Manual Testing

**Run existing tests with keep/clean options:**

```bash
# Option 1: Keep resources for manual inspection
make test-keep TEST_PATH=tests/test_create_lb.py TEST_FILTER="internet-facing and aws-6"

# After manual verification, clean up
make test-clean TEST_PATH=tests/test_create_lb.py TEST_FILTER="internet-facing and aws-6"

# Option 2: Quick test cycle (creates and destroys)
make test-clean TEST_PATH=tests/test_create_lb.py
```

**What to verify during manual test:**
- [ ] SNS topic created with ASG name format: `{asg_name}-alb-alarms`
- [ ] CloudWatch alarms created with ASG name format: `{asg_name}-unhealthy-hosts`, etc.
- [ ] Check `pytest-{timestamp}-output.log` for Terraform output showing resource names
- [ ] If keeping resources (`make test-keep`):
  - [ ] Manually check AWS Console for SNS topic names
  - [ ] Manually check CloudWatch alarms names
  - [ ] Verify alarm_emails received confirmation emails
  - [ ] Confirm subscriptions and trigger test alarm

**Expected changes in test output:**
- SNS topic names will use ASG names instead of service names
- Alarm names will use ASG names instead of service names
- No test failures

**If tests explicitly check resource names:**
- Update test assertions to expect ASG-based names
- Example: `assert topic_name.startswith(asg_name)`

**Makefile targets used:**
```bash
# From Makefile:
make test-keep   ## Run a test and keep resources (for manual verification)
make test-clean  ## Run a test and destroy resources (full cycle)
make test        ## Run all tests in tests/ directory
```

#### 3.2 CI Comprehensive Testing

**GitHub Actions runs full test suite:**
- All tests in `tests/` directory
- Multiple AWS regions
- Multiple Terraform/AWS provider versions
- Comprehensive integration scenarios

**After PR/merge:**
- [ ] Verify CI passes all tests
- [ ] Review CI logs for any warnings about resource naming
- [ ] Confirm no test failures related to alarm/SNS topic naming

#### 3.3 Multi-ASG Scenario Validation

**No dedicated test required** - too heavy for this change.

**Real validation:**
- Issue #104 will be validated when terraform-aws-elasticsearch successfully deploys with v5.13.0
- That module uses multiple website-pod instances with same `service_name` but different `asg_name` values
- Successful deployment = fix confirmed

### Step 4: Version and Release

**Release Workflow:**

#### 4.1 Create Pull Request

```bash
# Create feature branch
git checkout -b fix/sns-naming-conflict-104

# Make code changes (alarms.tf, asg.tf)
git add alarms.tf asg.tf

# Commit changes
git commit -m "fix: SNS topic naming conflict and remove obsolete lifecycle blocks

- Fix #104: Use ASG name instead of service name for SNS topics and alarms
- Fix #67: Remove create_before_destroy from ASG resources

OPERATIONAL IMPACT:
- Users must re-confirm SNS email subscriptions after upgrade
- No code changes required to user configurations

Enables terraform-aws-elasticsearch to deploy multiple node types.

Fixes #104
Fixes #67"

# Push branch
git push origin fix/sns-naming-conflict-104

# Create PR via GitHub CLI or web interface
gh pr create \
  --title "fix: SNS topic naming conflict (#104) and remove obsolete lifecycle blocks (#67)" \
  --body "See commit message for details. Fixes #104 and #67"
```

#### 4.2 PR Review and Testing

- [ ] Wait for CI tests to pass
- [ ] Get PR approved by reviewer
- [ ] Address any review comments
- [ ] Ensure all checks are green

#### 4.3 Merge PR

```bash
# Merge via GitHub (or CLI)
gh pr merge --squash  # or --merge depending on repo policy
```

#### 4.4 Release from Main Branch

**After PR is merged:**

```bash
# Switch to main and pull latest
git checkout main
git pull origin main

# Run release-minor (updates CHANGELOG, bumps version, creates tag)
make release-minor
# This will:
# 1. Prompt for confirmation
# 2. Update CHANGELOG.md with git-cliff
# 3. Bump version to 5.13.0 with bumpversion
# 4. Create commit with version bump
# 5. Create git tag v5.13.0

# Push commit and tags
git push origin main
git push origin --tags
```

#### 4.5 Terraform Registry Publication

**Automatic publishing:**
- Terraform Registry automatically picks up new tags from GitHub
- Verify publication at: https://registry.terraform.io/modules/infrahouse/website-pod/aws

**Manual verification:**
- [ ] Check registry shows v5.13.0
- [ ] Verify CHANGELOG is displayed correctly
- [ ] Check version constraint examples work

#### 4.4 Update terraform-aws-elasticsearch

After v5.13.0 is published:

**File:** terraform-aws-elasticsearch module configuration

```hcl
# Update version constraint
module "elastic_cluster" {
  source  = "infrahouse/website-pod/aws"
  version = "~> 5.13"  # Previously: ~> 5.12

  service_name = var.service_name
  asg_name     = "${var.service_name}-master"
  # ...
}

module "elastic_cluster_data" {
  source  = "infrahouse/website-pod/aws"
  version = "~> 5.13"  # Previously: ~> 5.12

  service_name = var.service_name
  asg_name     = "${var.service_name}-data"
  # ...
}
```

**Test deployment:**
```bash
cd terraform-aws-elasticsearch
terraform init -upgrade
terraform plan
# Verify no SNS topic naming conflicts
terraform apply
```

---

## Risk Assessment

| Risk | Likelihood | Severity | Mitigation |
|------|-----------|----------|------------|
| Email re-confirmation friction | High | Low | Clear documentation in CHANGELOG |
| Alarm history lost | High | Low | Metrics retained, only state history lost |
| Users miss confirmation email | Medium | Medium | Document in release notes, warn in CHANGELOG |
| Naming conflict in edge cases | Low | Medium | Use `aws_autoscaling_group.website.name` (guaranteed unique) |
| Behavioral change from lifecycle removal | Low | Low | Instance refresh already handles zero-downtime |
| Test failures | Medium | Low | Update tests to expect new naming pattern |

---

## Success Criteria

- [x] Issue #104: Multiple ASGs with same service name deploy without SNS conflicts
- [x] Issue #67: ASG lifecycle blocks removed, tests pass
- [x] All existing tests pass (with updated expectations)
- [x] New multi-ASG test passes
- [ ] Documentation updated (CHANGELOG, GitHub issues)
- [ ] terraform-aws-elasticsearch successfully uses v5.13.0
- [ ] Manual testing confirms alarms work after upgrade
- [ ] Release tagged and published to Terraform Registry

---

## Rollback Plan

If critical issues discovered in v5.13.0:

1. **Immediate:** Add `5.12.x` version constraint to docs as "stable"
2. **Communication:** GitHub issue + Terraform registry release notes
3. **Fix:** Address issues in v5.13.1 or v5.14.0
4. **Users can pin:** `version = "~> 5.12.0"` to avoid upgrade

**Note:** Rollback after upgrade requires re-confirming emails again (going back to old topic names).

---

## Timeline Estimate

- **Code changes:** 1 hour (straightforward find & replace)
- **Testing:** 2-3 hours (existing + new multi-ASG test)
- **Documentation:** 1 hour (CHANGELOG, GitHub comments)
- **Manual verification:** 1-2 hours (deploy, trigger alarms, verify emails)
- **Total:** ~1 day

---

## Post-Release Tasks

- [ ] Monitor GitHub issues for upgrade problems
- [ ] Update terraform-aws-elasticsearch to v5.13.0
- [ ] Communicate in Slack/email about email re-confirmation requirement
- [ ] Close GitHub issues #104 and #67
- [ ] Update project board/backlog
- [ ] Consider blog post about the fix (optional)

---

## Notes

- This is a **minor version** release (5.12.x → 5.13.0)
- **Not a breaking change** by semantic versioning definition
- Has **operational impact** requiring user action (email re-confirmation)
- Clear migration path with no code changes required
- Unblocks terraform-aws-elasticsearch deployment

---

**Document Created:** 2025-12-13
**Created By:** Claude (AI Assistant)
**Approved By:** [Pending review]
**Status:** Ready for implementation